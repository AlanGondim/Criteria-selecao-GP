import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from math import pi

# --- 1. Defini√ß√£o dos Crit√©rios, Pilares e Perguntas ---
CRITERIOS = {
    "P1_Experiencia_Perfil": {
        "label": "1. Experi√™ncia e Perfil",
        "max_score": 42,
        "questions": {
            # --- Q1: PADRONIZADA APENAS COM CHAVES DE LETRAS A/B/C ---
            "Q1": {"text": "Q1. Qual a sua aloca√ß√£o de tempo (em %) em projetos/programas ativos nos pr√≥ximos 6 meses?\n(A) 80 - 100% \n(B) 50 - 79% \n(C) <50%", 
                   "type": "choice", 
                   "max": 5, 
                   "mapping": {"A": 5, "B": 3, "C": 1}, 
                   "options": ["A", "B", "C"]}, 
            
            # --- Q2: PADRONIZADO PARA MAI√öSCULAS ---
            "Q2": {"text": "Q2. Voc√™ possui planos de f√©rias ou aus√™ncias significativas (> 5 dias √∫teis) no per√≠odo de go-live (fase final) de um Programa (pr√≥ximos 12 meses)?", 
                   "type": "choice", 
                   "max": 5, 
                   "mapping": {"N": 5, "S": 0}, 
                   "options": ["S", "N"]},
                   
            "Q3": {"text": "Q3. Qual o seu n√≠vel de prontid√£o para assumir um novo Programa de implanta√ß√£o de grande porte em 30 dias? (Escala 1 a 5)", "type": "scale", "max": 5, "options": [1, 2, 3, 4, 5]},
            
            # --- Q4: PADRONIZADO PARA MAI√öSCULAS ---
            "Q4": {"text": "Q4. Voc√™ j√° gerenciou Programas/Projetos que envolviam a coordena√ß√£o de 3 ou mais projetos simult√¢neos e interligados?", 
                   "type": "choice", 
                   "max": 5, 
                   "mapping": {"S": 5, "N": 0}, 
                   "options": ["S", "N"]},
                   
            # --- Q5: ALTERADA PARA 'value_input' (ENTRADA NUM√âRICA) ---
            "Q5": {"text": "Q5. Qual o maior valor de contrato (Programa ou Projeto) que voc√™ j√° gerenciou na √°rea de Sa√∫de? (Insira o valor em Milh√µes de Reais, ex: 1.5 para 1 milh√£o e meio)", 
                   "type": "value_input", 
                   "max": 5, 
                   "cutoff_milhoes": 1.0}, # Ponto de corte: 1 Milh√£o para pontua√ß√£o m√°xima
                   
            "Q6": {"text": "Q6. Em uma escala de 1 a 5, qu√£o confort√°vel voc√™ se sente em gerenciar riscos de terceiros (vendors)?", "type": "scale", "max": 5, "options": [1, 2, 3, 4, 5]},
            
            # --- Q7: PADRONIZADO PARA MAI√öSCULAS ---
            "Q7": {
                "text": "Q7. H√° quantos anos voc√™ atua na gest√£o de Programas ou Projetos de implanta√ß√£o de Sistemas de Gest√£o Hospitalar (HIS/EHR, ex: MV, Tasy, Soul)?\n(A) >= 5 anos \n(B) Entre 3 e 4 anos \n(C) < 3 anos", 
                "type": "choice",
                "max": 5, 
                "mapping": {"A": 5, "B": 3, "C": 1}, 
                "options": ["A", "B", "C"]
            },
            
            # --- Q8: MANTIDA ---
            "Q8": {
                "text": "Q8. Qual a certifica√ß√£o de gerenciamento de programas/projetos mais avan√ßada que voc√™ possui?\n(A) PgMP - Program Management Professional: Foco em gest√£o de Programas e alinhamento estrat√©gico.\n(B) PMP - Project Management Professional: Foco em gest√£o de Projetos.\n(C) CSM/PSM - Certified/Professional Scrum Master: Foco em m√©todos √Ågeis/Gest√£o de Projetos.\n(D) Nenhuma: N√£o possui certifica√ß√£o formal.",
                "type": "choice", 
                "max": 7, 
                "mapping": {"A": 7, "B": 5, "C": 3, "D": 0},
                "options": ["A", "B", "C", "D"]
            },
        }
    },
    "P2_Conhecimento_Tecnico": {
        "label": "2. Conhecimento T√©cnico",
        "max_score": 14,
        "questions": {
            "Q9": {"text": "Q9. Quantos m√≥dulos MV/HIS (PEP, Faturamento, Custos, Suprimentos) voc√™ j√° liderou a implanta√ß√£o completa (*full-cycle* com *go-live*)? (N√∫mero de m√≥dulos)", "type": "multi_select", "max": 4, "value_per_item": 1},
            "Q10": {
                "text": "Q10. Qual √© a principal diferen√ßa entre a gest√£o de Programas e a gest√£o de Projetos segundo o PMI?\n(A) Projetos foca na entrega de benef√≠cios, enquanto Programas foca em escopo e prazo.\n(B) Programas foca na obten√ß√£o de benef√≠cios e no alinhamento estrat√©gico, enquanto Projetos foca nas entregas espec√≠ficas e no escopo.\n(C) Programas usam metodologias √Ågeis e Projetos usam metodologias Preditivas (Waterfall).\n(D) N√£o h√° diferen√ßa significativa; √© apenas uma quest√£o de escala.",
                "type": "choice", 
                "max": 5, 
                "mapping": {"A": 0, "B": 5, "C": 0, "D": 0},
                "options": ["A", "B", "C", "D"]
            },
            "Q11": {
                "text": "Q11. Em um Programa MV, qual artefato √© essencial para gerenciar a sobreposi√ß√£o de recursos e os prazos cr√≠ticos entre projetos interdependentes?\n(A) WBS (Estrutura Anal√≠tica do Projeto) do Projeto de Faturamento.\n(B) Matriz de Interdepend√™ncias e Cronograma Mestre Integrado do Programa.\n(C) Plano de Comunica√ß√£o e o Log de Riscos Apenas.\n(D) Log de Stakeholders do Programa.",
                "type": "choice", 
                "max": 5, 
                "mapping": {"A": 0, "B": 5, "C": 0, "D": 0},
                "options": ["A", "B", "C", "D"]
            },
        }
    },
    "P3_Governanca_Comportamental": {
        "label": "3. Governan√ßa e Comportamento",
        "max_score": 20,
        "questions": {
            "Q12": {
                "text": "Q12. Qual √© o papel principal do Comit√™ Diretivo em um Programa de implanta√ß√£o hospitalar?\n(A) Realizar o treinamento dos usu√°rios finais do hospital.\n(B) Gerenciar o escopo t√©cnico di√°rio de cada projeto.\n(C) Aprovar ou rejeitar mudan√ßas de escopo que impactam o or√ßamento global do Programa e resolver quest√µes estrat√©gicas escaladas (Exercer Autoridade M√°xima).\n(D) Aprovar as especifica√ß√µes t√©cnicas de integra√ß√£o de sistemas.",
                "type": "choice", 
                "max": 5, 
                "mapping": {"A": 0, "B": 0, "C": 5, "D": 0},
                "options": ["A", "B", "C", "D"]
            },
            "Q13": {
                "text": "Q13. Sua PRIMEIRA a√ß√£o ao identificar que um projeto cr√≠tico (ex: Faturamento) est√° em atraso, com impacto no go-live, seria:\n(A) Realizar uma an√°lise de *Root Cause* e negociar imediatamente um plano de recupera√ß√£o com o Gerente do Projeto e o Sponsor interno.\n(B) Agendar reuni√£o com a Diretoria Executiva do hospital para negociar recursos adicionais.\n(C) Alterar o Cronograma Mestre do Programa para refletir o novo prazo de go-live.\n(D) Enviar um e-mail formal para a equipe de Faturamento pedindo para que trabalhem horas extras.",
                "type": "choice", 
                "max": 5, 
                "mapping": {"A": 5, "B": 0, "C": 0, "D": 0},
                "options": ["A", "B", "C", "D"]
            },
            "Q14": {
                "text": "Q14. Sua principal abordagem para engajamento e mitiga√ß√£o de resist√™ncia √† mudan√ßa por parte do corpo cl√≠nico (m√©dicos e enfermeiros) seria:\n(A) Criar um plano de comunica√ß√£o intensivo com e-mails semanais sobre o progresso do Programa.\n(B) Criar sess√µes de treinamento modulares, curtas, *on-demand* (v√≠deos) e designar m√©dicos-l√≠deres (*champions*) para promover a ades√£o.\n(C) Exigir que todos participem de um treinamento presencial obrigat√≥rio de 8 horas antes do go-live.\n(D) Focar exclusivamente no treinamento da equipe de TI.",
                "type": "choice", 
                "max": 5, 
                "mapping": {"A": 0, "B": 5, "C": 0, "D": 0},
                "options": ["A", "B", "C", "D"]
            },
            "Q15": {
                "text": "Q15. Ao mediar um conflito t√©cnico complexo (ex: requisitos de um *workflow*), sua primeira a√ß√£o seria:\n(A) Analisar os requisitos e a documenta√ß√£o t√©cnica (*Design Blueprint*) para determinar objetivamente a melhor solu√ß√£o alinhada ao escopo base.\n(B) Escalar o problema imediatamente para o Comit√™ Diretivo pedindo que um Diretor decida.\n(C) Optar pela solu√ß√£o proposta pela equipe de TI, pois s√£o os especialistas em sistemas.\n(D) Realizar uma vota√ß√£o entre os *stakeholders* envolvidos para determinar a solu√ß√£o mais popular.",
                "type": "choice", 
                "max": 5, 
                "mapping": {"A": 5, "B": 0, "C": 0, "D": 0},
                "options": ["A", "B", "C", "D"]
            },
        }
    }
}

# --- 1.1. Defini√ß√£o da Pontua√ß√£o Alvo (Meta) ---
PONTUACAO_ALVO_PERCENTUAL = 85.0

# --- 2. Fun√ß√£o de Coleta de Respostas do Usu√°rio (Original/Interativa com Valida√ß√£o) ---
def coletar_respostas(criterios):
    respostas = {}
    print("--- üìù IN√çCIO DO QUESTION√ÅRIO DE AVALIA√á√ÉO DE GERENTE DE PROGRAMAS MV ---")
    
    for pilar, dados_pilar in criterios.items():
        print(f"\n## {dados_pilar['label'].upper()}")
        
        for q_id, q_data in dados_pilar['questions'].items():
            print(f"\n{q_data['text']}")
            
            # --- L√≥gica de Valida√ß√£o para cada tipo de quest√£o ---
            
            if q_data["type"] == "choice":
                # L√≥gica para determinar as op√ß√µes v√°lidas (keys do mapping)
                opcoes_validas = list(q_data['mapping'].keys())
                options_str = " / ".join(opcoes_validas)
                
                while True:
                    resposta_raw = input(f"Selecione uma op√ß√£o v√°lida ({options_str}): ")
                    # 1. Converte a entrada para MAI√öSCULAS
                    resposta = resposta_raw.upper()
                    
                    # 2. Verifica se a resposta (agora mai√∫scula) est√° nas op√ß√µes v√°lidas (que est√£o em mai√∫sculas)
                    if resposta in opcoes_validas:
                        respostas[q_id] = resposta
                        break
                    
                    print(f"‚ùå Resposta inv√°lida. Por favor, escolha uma das seguintes op√ß√µes: {options_str}")
            
            elif q_data["type"] == "scale":
                min_val, max_val = 1, q_data['max']
                options_str = f"{min_val} a {max_val}"
                while True:
                    try:
                        resposta_str = input(f"Resposta (Escala de {options_str}): ")
                        resposta = int(resposta_str) # Tenta converter para inteiro
                        if min_val <= resposta <= max_val:
                            respostas[q_id] = resposta
                            break
                        else:
                            print(f"‚ùå Resposta inv√°lida. Por favor, insira um n√∫mero entre {min_val} e {max_val}.")
                    except ValueError:
                        print("‚ùå Entrada inv√°lida. Por favor, insira um n√∫mero inteiro.")
            
            elif q_data["type"] == "multi_select":
                min_val, max_val = 0, q_data['max']
                options_str = f"0 a {max_val} (Contagem de m√≥dulos)"
                while True:
                    try:
                        resposta_str = input(f"N√∫mero de itens selecionados (M√°x {max_val}): ")
                        resposta = int(resposta_str) # Tenta converter para inteiro
                        if min_val <= resposta <= max_val:
                            respostas[q_id] = resposta
                            break
                        else:
                            print(f"‚ùå Resposta inv√°lida. Por favor, insira um n√∫mero entre {min_val} e {max_val}.")
                    except ValueError:
                        print("‚ùå Entrada inv√°lida. Por favor, insira um n√∫mero inteiro.")
            
            # --- NOVO BLOCO DE VALIDA√á√ÉO PARA 'value_input' (Q5) ---
            elif q_data["type"] == "value_input":
                while True:
                    try:
                        resposta_str = input("Insira o valor em milh√µes de reais (ex: 1.5): ")
                        resposta = float(resposta_str.replace(',', '.')) # Aceita v√≠rgula ou ponto
                        respostas[q_id] = resposta
                        break
                    except ValueError:
                        print("‚ùå Entrada inv√°lida. Por favor, insira um valor num√©rico (pode usar ponto ou v√≠rgula).")
                        
            elif q_data["type"] == "correct_answer":
                opcoes_validas = ["S", "N"]
                options_str = " / ".join(opcoes_validas)
                while True:
                    # J√° √© padronizado para mai√∫sculas
                    resposta_str = input(f"A afirma√ß√£o √© correta para voc√™? ({options_str}): ").upper()
                    if resposta_str in opcoes_validas:
                        respostas[q_id] = (resposta_str == "S")
                        break
                    else:
                        print(f"‚ùå Entrada inv√°lida. Digite 'S' para Sim ou 'N' para N√£o.")
                        
    print("\n--- ‚úÖ QUESTION√ÅRIO CONCLU√çDO ---")
    return respostas

# --- 3. Implementa√ß√£o da L√≥gica de Scoring ---
def calcular_score(respostas, criterios):
    """Calcula a pontua√ß√£o em cada pilar e retorna em percentual."""
    scores = {}
    
    for pilar, dados_pilar in criterios.items():
        score_obtido = 0
        
        for q_id, q_data in dados_pilar['questions'].items():
            resposta = respostas.get(q_id)
            
            if resposta is None:
                continue

            if q_data["type"] == "choice":
                # A pontua√ß√£o funciona porque a resposta j√° foi normalizada para mai√∫sculas na coleta
                score_obtido += q_data["mapping"].get(resposta, 0)
            
            elif q_data["type"] == "scale":
                if isinstance(resposta, int):
                    score_obtido += max(1, min(resposta, q_data["max"]))
            
            elif q_data["type"] == "multi_select":
                if isinstance(resposta, int):
                    score_obtido += min(resposta * q_data["value_per_item"], q_data["max"])

            # --- L√≥gica de Pontua√ß√£o para 'value_input' (Q5) ---
            elif q_data["type"] == "value_input":
                if isinstance(resposta, (int, float)):
                    cutoff = q_data.get("cutoff_milhoes", 1.0) # Assume 1.0 se n√£o estiver definido
                    if resposta >= cutoff:
                        score_obtido += q_data["max"] # 5 pontos
            
            elif q_data["type"] == "correct_answer":
                if resposta is True:
                    score_obtido += q_data["max"]

        score_percentual = (score_obtido / dados_pilar['max_score']) * 100
        scores[pilar] = {"score": score_obtido, "max": dados_pilar['max_score'], "percentual": round(score_percentual, 1)}
        
    return scores

# --- 4. Implementa√ß√£o do Plotting (Mantido Inalterado) ---
def plot_radar_chart(resultados, criterios, target_percentual):
    """Gera o gr√°fico de radar das compet√™ncias com destaque neon e meta."""
    
    pilares = list(resultados.keys())
    labels_pilares = [criterios[pilar]['label'] for pilar in pilares]
    scores_avaliado = [resultados[pilar]['percentual'] for pilar in pilares]
    
    N = len(pilares)
    angles = [n / float(N) * 2 * pi for n in range(N)]
    angles += angles[:1]
    
    # Prepara√ß√£o dos dados para plotagem
    scores_avaliado_plot = scores_avaliado + scores_avaliado[:1]
    scores_alvo_plot = [target_percentual] * (N + 1)
    
    # Cria a figura com fundo escuro para real√ßar o neon
    fig, ax = plt.subplots(figsize=(10, 10), subplot_kw=dict(polar=True))
    fig.patch.set_facecolor('#1e1e1e')
    ax.set_facecolor('#1e1e1e')
    
    # Cores Neon
    COLOR_AVALIADO = '#FF6600'
    COLOR_ALVO = '#00FFFF' 
    
    # --- Plotar Pontua√ß√£o Alvo (Meta) ---
    ax.plot(angles, scores_alvo_plot, linewidth=2, linestyle='--', label=f'Meta ({target_percentual}%)', color=COLOR_ALVO)
    
    # --- Plotar Pontua√ß√£o do Avaliado ---
    ax.plot(angles, scores_avaliado_plot, linewidth=3, linestyle='solid', label='Pontua√ß√£o Avaliado', color=COLOR_AVALIADO)
    ax.fill(angles, scores_avaliado_plot, COLOR_AVALIADO, alpha=0.3)
    
    # --- Configura√ß√µes de Apar√™ncia ---
    ax.tick_params(colors='white') 
    ax.set_xticks(angles[:-1])
    ax.set_xticklabels(labels_pilares, size=14, color='white', weight='bold')
    
    # Eixo Y (Score)
    ax.set_yticks(np.arange(0, 101, 25))
    ax.set_yticklabels([f"{i}%" for i in np.arange(0, 101, 25)], color="grey", size=10)
    ax.set_ylim(0, 100)
    
    # Posi√ß√£o do Gr√°fico
    ax.set_theta_offset(pi / 2)
    ax.set_theta_direction(-1)
    
    # T√≠tulo
    ax.set_title("Radar chart | Crit√©rios de Sele√ß√£o do Gerente de Programa", size=18, y=1.1, color='white', weight='bold')
    ax.legend(loc='lower left', bbox_to_anchor=(0.8, 0.95), frameon=True, facecolor='#333333', edgecolor='white', labelcolor='white')

    # Adiciona a pontua√ß√£o em texto pr√≥ximo ao ponto
    for angle, score in zip(angles[:-1], scores_avaliado):
        ax.text(angle, score + 4, f'{score:.1f}%', size=11, weight='bold', ha='center', va='center', color=COLOR_AVALIADO)
    
    plt.savefig('radar_competencias_avaliado_neon.png', facecolor=fig.get_facecolor())
    plt.show()

# --- 5. Fun√ß√£o Principal de Execu√ß√£o (REATIVADA) ---
def main():
    # Coleta as respostas do usu√°rio de forma interativa (requer input no terminal)
    respostas_usuario = coletar_respostas(CRITERIOS)
    
    # Calcula a pontua√ß√£o
    resultados = calcular_score(respostas_usuario, CRITERIOS)
    
    print("\n--- RESULTADOS GERAIS ---")
    for pilar, res in resultados.items():
        print(f"Pilar {CRITERIOS[pilar]['label']}: {res['percentual']}% (Score: {res['score']}/{res['max']})")

    # Plota o Radar Chart
    plot_radar_chart(resultados, CRITERIOS, PONTUACAO_ALVO_PERCENTUAL)
    
    print("\nO gr√°fico radar foi gerado e salvo como 'radar_competencias_avaliado_neon.png'.")

# Execu√ß√£o do programa
if __name__ == "__main__":
    main()
